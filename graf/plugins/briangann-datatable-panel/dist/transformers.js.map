{"version":3,"sources":["../src/transformers.js"],"names":["transformDataToTable","data","panel","model","TableModel","length","transformer","transformers","transform","message","_","moment","flatten","TimeSeries","timeseries_to_rows","description","getColumns","columns","text","type","i","series","y","datapoints","dp","rows","push","target","timeseries_to_columns","points","timeKey","toString","time","point","values","value","timeseries_aggregations","alias","getFlotPairs","cells","stats","annotations","evt","min","title","tags","table","undefined","json","names","maxDocs","Math","doc","flattened","propName","map","key","z","isObject","JSON","stringify"],"mappings":"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","file":"transformers.js","sourcesContent":["\nimport _ from 'lodash';\nimport moment from 'moment';\nimport flatten from 'app/core/utils/flatten';\nimport TimeSeries from 'app/core/time_series2';\nimport TableModel from 'app/core/table_model';\n\nvar transformers = {};\n\ntransformers.timeseries_to_rows = {\n  description: 'Time series to rows',\n  getColumns: function() {\n    return [];\n  },\n  transform: function(data, panel, model) {\n    model.columns = [\n      {text: 'Time', type: 'date'},\n      {text: 'Metric'},\n      {text: 'Value'},\n    ];\n\n    for (var i = 0; i < data.length; i++) {\n      var series = data[i];\n      for (var y = 0; y < series.datapoints.length; y++) {\n        var dp = series.datapoints[y];\n        model.rows.push([dp[1], series.target, dp[0]]);\n      }\n    }\n  },\n};\n\ntransformers.timeseries_to_columns = {\n  description: 'Time series to columns',\n  getColumns: function() {\n    return [];\n  },\n  transform: function(data, panel, model) {\n    model.columns.push({text: 'Time', type: 'date'});\n\n    // group by time\n    var points = {};\n\n    for (var i = 0; i < data.length; i++) {\n      var series = data[i];\n      model.columns.push({text: series.target});\n\n      for (var y = 0; y < series.datapoints.length; y++) {\n        var dp = series.datapoints[y];\n        var timeKey = dp[1].toString();\n\n        if (!points[timeKey]) {\n          points[timeKey] = {time: dp[1]};\n          points[timeKey][i] = dp[0];\n        } else {\n          points[timeKey][i] = dp[0];\n        }\n      }\n    }\n\n    for (var time in points) {\n      var point = points[time];\n      var values = [point.time];\n\n      for (let i = 0; i < data.length; i++) {\n        var value = point[i];\n        values.push(value);\n      }\n\n      model.rows.push(values);\n    }\n  }\n};\n\ntransformers.timeseries_aggregations = {\n  description: 'Time series aggregations',\n  getColumns: function() {\n    return [\n      {text: 'Avg', value: 'avg'},\n      {text: 'Min', value: 'min'},\n      {text: 'Max', value: 'max'},\n      {text: 'Total', value: 'total'},\n      {text: 'Current', value: 'current'},\n      {text: 'Count', value: 'count'},\n    ];\n  },\n  transform: function(data, panel, model) {\n    var i, y;\n    model.columns.push({text: 'Metric'});\n\n    if (panel.columns.length === 0) {\n      panel.columns.push({text: 'Avg', value: 'avg'});\n    }\n\n    for (i = 0; i < panel.columns.length; i++) {\n      model.columns.push({text: panel.columns[i].text});\n    }\n\n    for (i = 0; i < data.length; i++) {\n      var series = new TimeSeries({\n        datapoints: data[i].datapoints,\n        alias: data[i].target,\n      });\n\n      series.getFlotPairs('connected');\n      var cells = [series.alias];\n\n      for (y = 0; y < panel.columns.length; y++) {\n        cells.push(series.stats[panel.columns[y].value]);\n      }\n\n      model.rows.push(cells);\n    }\n  }\n};\n\ntransformers.annotations = {\n  description: 'Annotations',\n  getColumns: function() {\n    return [];\n  },\n  transform: function(data, panel, model) {\n    model.columns.push({text: 'Time', type: 'date'});\n    model.columns.push({text: 'Title'});\n    model.columns.push({text: 'Text'});\n    model.columns.push({text: 'Tags'});\n\n    if (!data || data.length === 0) {\n      return;\n    }\n\n    for (var i = 0; i < data.length; i++) {\n      var evt = data[i];\n      model.rows.push([evt.min, evt.title, evt.text, evt.tags]);\n    }\n  }\n};\n\ntransformers.table = {\n  description: 'Table',\n  getColumns: function(data) {\n    if (!data || data.length === 0) {\n      return [];\n    }\n  },\n  transform: function(data, panel, model) {\n    if (!data || data.length === 0) {\n      return;\n    }\n\n    if (data[0] === undefined) {\n      throw {message: 'Query result is not in table format, try using another transform.'};\n    }\n    if (data[0].type === undefined) {\n      throw {message: 'Query result is not in table format, try using another transform.'};\n    }\n    if (data[0].type !== 'table') {\n      throw {message: 'Query result is not in table format, try using another transform.'};\n    }\n    model.columns = data[0].columns;\n    model.rows = data[0].rows;\n  }\n};\n\ntransformers.json = {\n  description: 'JSON Data',\n  getColumns: function(data) {\n    if (!data || data.length === 0) {\n      return [];\n    }\n\n    var names = {};\n    for (var i = 0; i < data.length; i++) {\n      var series = data[i];\n      if (series.type !== 'docs') {\n        continue;\n      }\n\n      // only look at 100 docs\n      var maxDocs = Math.min(series.datapoints.length, 100);\n      for (var y = 0; y < maxDocs; y++) {\n        var doc = series.datapoints[y];\n        var flattened = flatten(doc, null);\n        for (var propName in flattened) {\n          names[propName] = true;\n        }\n      }\n    }\n\n    return _.map(names, function(value, key) {\n      return {text: key, value: key};\n    });\n  },\n  transform: function(data, panel, model) {\n    var i, y, z;\n    for (i = 0; i < panel.columns.length; i++) {\n      model.columns.push({text: panel.columns[i].text});\n    }\n\n    if (model.columns.length === 0) {\n      model.columns.push({text: 'JSON'});\n    }\n\n    for (i = 0; i < data.length; i++) {\n      var series = data[i];\n\n      for (y = 0; y < series.datapoints.length; y++) {\n        var dp = series.datapoints[y];\n        var values = [];\n\n        if (_.isObject(dp) && panel.columns.length > 0) {\n          var flattened = flatten(dp, null);\n          for (z = 0; z < panel.columns.length; z++) {\n            values.push(flattened[panel.columns[z].value]);\n          }\n        } else {\n          values.push(JSON.stringify(dp));\n        }\n\n        model.rows.push(values);\n      }\n    }\n  }\n};\n\nfunction transformDataToTable(data, panel) {\n  var model = new TableModel();\n\n  if (!data || data.length === 0) {\n    return model;\n  }\n\n  var transformer = transformers[panel.transform];\n  if (!transformer) {\n    throw {message: 'Transformer ' + panel.transformer + ' not found'};\n  }\n\n  transformer.transform(data, panel, model);\n  return model;\n}\n\nexport {transformers, transformDataToTable};\n"]}